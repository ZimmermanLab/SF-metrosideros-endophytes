---
title: "Metrosideros excelsa endophyte morphotype analysis"
author: "Emma Gibson and Naupaka Zimmerman"
date: "6/14/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r install-load-packages}
# install and load packages as needed 
if (!require("dplyr")) {
  install.packages("dplyr")
  library("dplyr")
}

if (!require("tidyr")) {
  install.packages("tidyr")
  library("dplyr")
}

if (!require("vegan")) {
  install.packages("vegan")
  library("vegan")
}
```

# Data Cleaning

First we'll read in the three datasets downloaded from Google Spreadsheets.

```{r read-in-data}
tree_meta <- read.csv("data/2017-06-09_M_excel_tree_metadata - Sheet1.csv")
morphotype_group <- read.csv("data/2017-06-09_M_excel_morphotyping - Sheet1.csv")
culture_info <- read.csv("data/2017-02-16_culturing_worksheet - Sheet1.csv")
```

Then we will use the `join()` functions from the `dplyr` package to merge the three datasets together so that we can figure out which morphotypes were found in which trees.

```{r join-data}
# join all the data frames together based on shared columns 
joined_data <- morphotype_group %>%
  left_join(culture_info, by = c("full_culture_ID" = "Label_ID")) %>%
  left_join(tree_meta, by = c("From_Label_ID" = "Tree_ID"))
```

We need to remove one of the rows here - it looks like xulture ZUSF00366 was entered twice on accident. Then we use the `spread()` function in `tidyr` to turn the long format data into wide format data (with trees as rows and MOTUs as columns), which is what we need for most kinds of community analyses.

```{r make-community-matrix}
# Need to remove a duplicated row for ZUSF00366, was entered twice by accident
# >Error: Duplicate identifiers for rows (93, 96)
community_matrix <- joined_data %>%
  distinct(full_culture_ID, .keep_all = TRUE) %>%
  count(From_Label_ID, motu_id) %>%
  spread(motu_id, n, fill = 0) 
```

Once we have the spread out community matrix, we can add back on the metadata for each tree, again using the `join()` function. We'll get rid of the test 'Parker' site for now because it only has one rep.

```{r join-community-matrix}
community_and_metadata <- tree_meta %>%
  left_join(community_matrix, by = c("Tree_ID" = "From_Label_ID")) %>%
  filter(Site_ID != "Parker")
```

Finally, we make another data frame that just has the MOTU counts and has the tree IDs as row names. This is the format that the `vegan` package prefers and will make using it more easy. See the [`vegan` vignette](http://cc.oulu.fi/~jarioksa/opetus/metodi/vegantutor.pdf) for more info.

```{r make-matrix-for-vegan}
comm_for_vegan <- community_and_metadata %>%
  select(starts_with("MOTU"))

rownames(comm_for_vegan) <- community_and_metadata$Tree_ID
```

# Data Analysis

Some fun analyses go here!

```{r}
# from http://rstudio-pubs-static.s3.amazonaws.com/11473_29c2de401c55441ca5350862ebd04456.html
richness <- rowSums(comm_for_vegan > 0)
sp.abund <- rowSums(comm_for_vegan)  #gives the number of individuals found in each plot
raremax <- min(rowSums(comm_for_vegan))  #rarefaction uses the smallest number of observations (individuals here) per sample to extrapolate the expected number if all other samples only had that number of observations
raremax
Srare <- rarefy(comm_for_vegan, raremax)
par(mfrow = c(1, 2))
plot(sp.abund, Srare, xlab = "Observed No. of Species", ylab = "Rarefied No. of Species")
rarecurve(comm_for_vegan, col = "blue")


```

The rightmost graph shows that even in our largest sample sizes, we cultured only a small portion of the total diversity. If we our samples reflected the total diversity in the area, we would expect the curves to gradually plateau. However, all of the curves remain fairly steep, indicating thatt here is still much diversity in these sites that remains unaccounted for.
Interestingly, it also appears that the trees in Site 2, which had a significantly lower isolation frequencies than those in the other sites, had similar curves to the other sites, indicating that they had as much diversity. The graph on the left confirms this observation, further indicating that all of the sites have a similar amount of diversity, despite the number of species in each.


```{r}
shannon <- diversity(comm_for_vegan)
boxplot(shannon ~ droplevels(tree_meta$Site_ID[2:13]))

```

This graph indicates that Site 3 had the largest diversity by a small margin, while Sites 1 and 3 have fairly similar levels of diversity. Site 2 shows by far the greatest amount of variation in diversity, which makes sense given that it had the smallest sample size and, therefore, the largest margin of error.


```{r}
rraremax <- rrarefy(comm_for_vegan, sample = raremax)
rrshannon <- diversity(rraremax)
boxplot(rrshannon ~ droplevels(tree_meta$Site_ID[2:13]))
#running this yields a different graph every time


```

These graphs highlight that the pattern of diversity between each site is marginal at best, due to the large difference between sample sizes for each site. Because it takes different MOTUs into account every time, it effectively makes the sample size the same for each site, yielding different graphs each time its program is run. These graphs and their relationship to each other look different every time, indicating that the sites would show similar levels of diversity if they were all of the same sample size.


```{r}
site_communities <- community_and_metadata %>% 
  group_by(Site_ID) %>%
  select(starts_with("MOTU")) %>%
  summarise_all(funs(sum))

row.names(site_communities) <- pull(site_communities, Site_ID)
site_comm_vegan <- site_communities %>%
  select(starts_with("MOTU"))

rarecurve(site_comm_vegan, col = "blue")


```

This graph indicates that the preliminary samples reflected only a small portion of the diversity within each site. Although it is similar to the first graphs above, it is different in that it groups all the trees in each site together. Initially, I thought that this might show that while no individual tree showed the full species diversity of its area, the combined diversity of the trees in each site might show a greater portion overall. Although the curves do appear to be a little less steep, if we had actually sampled all of the diversity in the area, then they would appear to plateau much more than they do, indicating that there is still much more diversity in each of these sites.
Like with the previous graphs, the curve for Site 2 appears almost identical to that of Site 3, indicating that it has a similar level of species diversity despite the lower mount of fungus cultured from it. Interestingly, Site 1 appears to have slightly less diversity than the other sites, likely because of the large quantities of MOTU 17 there.

